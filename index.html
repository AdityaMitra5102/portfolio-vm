<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Emscripten-Generated Code</title>
    <style>
      body {
        font-family: arial;
        margin: 0;
        padding: none;
      }

      .emscripten { padding-right: 0; margin-left: auto; margin-right: auto; display: block; }
      div.emscripten { text-align: center; }      
      div.emscripten_border { border: 1px solid black; }
      /* the canvas *must not* have any border or padding, or mouse coords will be wrong */
      canvas.emscripten { border: 0px none; float: left;}
      #qemu_stats {
        display: inline-block;
        float: left;
        vertical-align: center;
      }

      #emscripten_logo {
        display: inline-block;
        margin: 0;
      }

      .spinner {
        height: 30px;
        width: 30px;
        margin: 0;
        margin-top: 20px;
        margin-left: 20px;
        display: inline-block;
        vertical-align: top;

        -webkit-animation: rotation .8s linear infinite;
        -moz-animation: rotation .8s linear infinite;
        -o-animation: rotation .8s linear infinite;
        animation: rotation 0.8s linear infinite;

        border-left: 5px solid rgb(235, 235, 235);
        border-right: 5px solid rgb(235, 235, 235);
        border-bottom: 5px solid rgb(235, 235, 235);
        border-top: 5px solid rgb(120, 120, 120);
        
        border-radius: 100%;
        background-color: rgb(189, 215, 46);
      }

      @-webkit-keyframes rotation {
        from {-webkit-transform: rotate(0deg);}
        to {-webkit-transform: rotate(360deg);}
      }
      @-moz-keyframes rotation {
        from {-moz-transform: rotate(0deg);}
        to {-moz-transform: rotate(360deg);}
      }
      @-o-keyframes rotation {
        from {-o-transform: rotate(0deg);}
        to {-o-transform: rotate(360deg);}
      }
      @keyframes rotation {
        from {transform: rotate(0deg);}
        to {transform: rotate(360deg);}
      }

      #status {
        display: inline-block;
        vertical-align: top;
        margin-top: 30px;
        margin-left: 20px;
        font-weight: bold;
        color: rgb(120, 120, 120);
      }

      #progress {
        height: 20px;
        width: 30px;
      }

      #controls {
        display: inline-block;
        float: right;
        vertical-align: top;
        margin-top: 30px;
        margin-right: 20px;
      }

      #output {
        width: 100%;
        height: 200px;
        margin: 0 auto;
        margin-top: 10px;
        border-left: 0px;
        border-right: 0px;
        padding-left: 0px;
        padding-right: 0px;
        display: block;
        background-color: black;
        color: white;
        font-family: 'Lucida Console', Monaco, monospace;
        outline: none;
      }
    </style>
  </head>
  <body>


    <div class="spinner" id='spinner'></div>
    <div class="emscripten" id="status">Downloading...</div>

<span id='controls'>
  <span><input type="checkbox" id="resize">Resize canvas</span>
  <span><input type="checkbox" id="pointerLock" checked>Lock/hide mouse pointer &nbsp;&nbsp;&nbsp;</span>
  <span><input type="button" style="display:none" value="Fullscreen" onclick="Module.requestFullScreen(document.getElementById('pointerLock').checked, 
                                                                            document.getElementById('resize').checked)">
  </span>
</span>

    <div class="emscripten">
      <progress value="0" max="100" id="progress" hidden=1></progress>
    </div>

  <div id="startup" style="margin:auto;max-width:500px">
    Are you sure to download Qemu.js (about <b>30-40 Mb</b> uncompressed)? Please note that <b>browser may freeze!</b><br/>
    <b>Work in progress.</b> Build instructions see <a href="https://github.com/atrosinenko/qemujs-builder">here</a>.<br/>
    Guest architecture: <select id="arch"></select> <br/>
    Memory size allocated for Qemu in MB: <input type="number" id="memSize" value="512"> <br/>
    <input type="button" onclick="javascript:downloadQemu();" value="Download">
  </div>

  <div id="configuration" style="display:none">
    <table style="margin:auto">
      <tr>
        <td>Memory MB</td>
        <td><input type="number" id="qemu_m" value="256"></td>
      </tr>
      <tr>
        <td>Preset</td>
        <td><select id="preset" onchange="javascript:presetChanged();"></select></td>
      </tr>
      <tr>
        <td>Description</td>
        <td id="preset_description" colspan="2"></td>
      </tr>
      <tr>
        <td>Kernel</td>
        <td><input type="text" id="qemu_kernel" oninput="javascript:validateImage('kernel', false);"></td>
        <td id="qemu_kernel_comment"></td>
      </tr>
      <tr>
        <td>Initrd</td>
        <td><input type="text" id="qemu_initrd" oninput="javascript:validateImage('initrd', false);"></td>
        <td id="qemu_initrd_comment"></td>
      </tr>
      <tr>
        <td>Command line</td>
        <td><input type="text" id="qemu_append"></td>
        <td id="qemu_append_comment"></td>
      </tr>
      <tr>
        <td>Floppy</td>
        <td><input type="text" id="qemu_fda" oninput="javascript:validateImage('fda', true);"></td>
        <td id="qemu_fda_comment"></td>
      </tr>
      <tr>
        <td>HDD</td>
        <td><input type="text" id="qemu_hda" oninput="javascript:validateImage('hda', true);"></td>
        <td id="qemu_hda_comment"></td>
      </tr>
      <tr>
        <td>CD-ROM</td>
        <td><input type="text" id="qemu_cdrom" oninput="javascript:validateImage('cdrom', true);"></td>
        <td id="qemu_cdrom_comment"></td>
      </tr>
      <tr>
        <td>Misc options</td>
        <td><input type="text" id="qemu_misc"></td>
      </tr>
      <tr>
        <td colspan="2"><input type="button" onclick="javascript:runQemu();" value="Run"></td>
      </tr>
    </table>
  </div>

  <div id="main_controls" style="display:none">
    <div class="emscripten_border">
      <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>
      <div id="qemu_stats">
        Some stats
      </div> <br/> <br/> <br/>
      Compile TB after <select id="tbCompileThreshold">
        <option>0</option>
        <option>10</option>
        <option selected="true">100</option>
        <option>1000</option>
        <option>1e10</option>
      </select> executions.<br/>
      Print next <select id="printNextCompiledTBs">
        <option selected="true">0</option>
        <option>1</option>
        <option>10</option>
        <option>100</option>
      </select> compiled TBs.<br/>
      <input type="button" onclick="javascript:applyCompilerSettings()" value="Apply">
      <input type="button" onclick="javascript:resetCompilerCache()" value="Reset TB cache">
    </div>
  </div>
    <textarea id="output" rows="8" style="display:none"></textarea>

    <script type='text/javascript'>
      var statusElement = document.getElementById('status');
      var progressElement = document.getElementById('progress');
      var spinnerElement = document.getElementById('spinner');
      var qemuStatsElement = document.getElementById('qemu_stats');
      var startupElement = document.getElementById('startup');
      var configurationElement = document.getElementById('configuration');
      var archElement = document.getElementById('arch');
      var mainControlsElement = document.getElementById('main_controls');
      var memSizeElement = document.getElementById('memSize');
      var presetElement = document.getElementById('preset');
      var qemu_m_element = document.getElementById('qemu_m');
      var qemuMiscOptionsElement = document.getElementById('qemu_misc');
      var presetDescriptionElement = document.getElementById('preset_description');

      var Module = {
        preRun: [],
        postRun: [],
        print: (function() {
          var element = document.getElementById('output');
          if (element) element.value = ''; // clear browser cache
          return function(text) {
            if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
            // These replacements are necessary if you render to raw HTML
            //text = text.replace(/&/g, "&amp;");
            //text = text.replace(/</g, "&lt;");
            //text = text.replace(/>/g, "&gt;");
            //text = text.replace('\n', '<br>', 'g');
            console.log(text);
            if (element) {
              element.value += text + "\n";
              element.scrollTop = element.scrollHeight; // focus on bottom
            }
          };
        })(),
        printErr: function(text) {
          if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(' ');
          if (0) { // XXX disabled for safety typeof dump == 'function') {
            dump(text + '\n'); // fast, straight to the real console
          } else {
            console.error(text);
          }
        },
        canvas: (function() {
          var canvas = document.getElementById('canvas');

          // As a default initial behavior, pop up an alert when webgl context is lost. To make your
          // application robust, you may want to override this behavior before shipping!
          // See http://www.khronos.org/registry/webgl/specs/latest/1.0/#5.15.2
          canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);

          return canvas;
        })(),
        setStatus: function(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: '' };
          if (text === Module.setStatus.text) return;
          var m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          var now = Date.now();
          if (m && now - Date.now() < 30) return; // if this is a progress update, skip it if too soon
          if (m) {
            text = m[1];
            progressElement.value = parseInt(m[2])*100;
            progressElement.max = parseInt(m[4])*100;
            progressElement.hidden = false;
            spinnerElement.hidden = false;
          } else {
            progressElement.value = null;
            progressElement.max = null;
            progressElement.hidden = true;
            if (!text) spinnerElement.style.display = 'none';
          }
          statusElement.innerHTML = text;
        },
        setQemuStats: function(tb_per_sec, compiled_tb_percent, compiler_cpu) {
          qemuStatsElement.innerHTML = 
            "kTB/sec: " + tb_per_sec / 1000 + "<br/>" +
            "Compiled TB: " + compiled_tb_percent + "% (" + Object.keys(CompiledTB).length + ")<br/>" +
            "Compiler time: " + compiler_cpu + "%";
        },
        totalDependencies: 0,
        monitorRunDependencies: function(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(left ? 'Preparing... (' + (this.totalDependencies-left) + '/' + this.totalDependencies + ')' : 'All downloads complete.');
        }
      };
      Module.setStatus('Downloading...');
      window.onerror = function(event) {
        // TODO: do not warn on ok events like simulating an infinite loop or exitStatus
        Module.setStatus('Exception thrown, see JavaScript console');
        spinnerElement.style.display = 'none';
        Module.setStatus = function(text) {
          if (text) Module.printErr('[post-exception status] ' + text);
        };
      };

      function setDownloading(downloading) {
        Module.setStatus(downloading ? 'Downloading...' : '');
        spinnerElement.style.display = downloading ? 'inline-block' : 'none';
      }

      (function() {
        var xhr = new XMLHttpRequest();
        xhr.onload = function(event) {
          presets = xhr.response;
          for(var key in presets) {
            var newOption = document.createElement("option");
            newOption.value = key;
            newOption.text = presets[key].name;
            archElement.options.add(newOption);
            initpage();
            
          }
        };
        xhr.open("GET", "presets.json");
        xhr.responseType = 'json';
        xhr.send(null);
      })();

      var SPECIAL_FILE = 0;
      var RAW_TEXT = 1;
      var qemu_args = {
        'kernel': SPECIAL_FILE,
        'initrd': SPECIAL_FILE,
        'append': RAW_TEXT,
        'fda':    'if=floppy,index=0',
        'hda':    'if=ide,index=0,media=disk',
        'cdrom':  'if=ide,index=1,media=cdrom',
        'misc': null
      };

      function presetChanged() {
        var p = presets[archElement.value].variants[presetElement.value];
        for(k in qemu_args) {
          var inputField = document.getElementById('qemu_' + k);
          inputField.value = p[k] || "";
          if(qemu_args[k] !== RAW_TEXT && qemu_args[k] !== null)
            inputField.oninput();
        }
        presetDescriptionElement.textContent = p['description'];
      }

      function downloadQemu() {
        var arch = archElement.value;
        startupElement.style.display = 'none';
        Module['TOTAL_MEMORY'] = (memSizeElement.value|0) * 1024 * 1024;
        for(var key in presets[arch].variants) {
          var newOption = document.createElement("option");
          newOption.text = key;
          presetElement.options.add(newOption);
        }
        presetChanged();

        load_runtime(arch);
      }

      function load_runtime(arch) {
        setDownloading(true);
        (function() {
            var memoryInitializer = 'qemu-system-' + arch + '.html.mem';
            if (typeof Module['locateFile'] === 'function') {
              memoryInitializer = Module['locateFile'](memoryInitializer);
            } else if (Module['memoryInitializerPrefixURL']) {
              memoryInitializer = Module['memoryInitializerPrefixURL'] + memoryInitializer;
            }
            var xhr = Module['memoryInitializerRequest'] = new XMLHttpRequest();
            xhr.open('GET', memoryInitializer, true);
            xhr.responseType = 'arraybuffer';
            xhr.send(null);
        })();

        Module['onRuntimeInitialized'] = function() {
          configurationElement.style.display = 'block';
        }

        var emterpretXHR = new XMLHttpRequest();
        emterpretXHR.open('GET', 'qemu-system-' + arch + '-emterpreter.data', true);
        emterpretXHR.responseType = 'arraybuffer';
        emterpretXHR.onload = function() {
          Module.emterpreterFile = emterpretXHR.response;

          var script = document.createElement('script');
          script.src = "qemu-system-" + arch + ".js";
          document.body.appendChild(script);
        };
        emterpretXHR.onerror = emterpretXHR.onload;
        emterpretXHR.send(null);
      }

      function fileForDownload(str) {
        if(str.startsWith('downloaded/'))
          return str.substr(11);
        else
          return null;
      }

      function allocationSize(str) {
        if(str.startsWith('temp/'))
          return parseInt(str.substr(5))|0;
        else
          return null;
      }

      function isRawImage(name) {
        return name.endsWith(".raw");
      }

      function validateImage(key, block_device) {
        var value = document.getElementById('qemu_' + key).value;
        var commentElement = document.getElementById('qemu_' + key + '_comment');
        var download = fileForDownload(value);
        var allocSize = allocationSize(value);
        if(!block_device)
          var fmt = "";
        else if(isRawImage(value))
          var fmt = ", fmt: raw";
        else
          var fmt = ", fmt: guess";
        if(download !== null) {
          commentElement.innerHTML = 'Will download ' + download + ' on run' + fmt;
        } else if(allocSize !== null && block_device) {
          commentElement.innerHTML = 'Will allocate ' + allocSize + 'Mb on run' + fmt;
        } else if(value == '') {
          commentElement.innerHTML = '';
        } else if(FS.analyzePath(value).exists) {
          commentElement.innerHTML = 'Will use preloaded file' + fmt;
        } else {
          commentElement.innerHTML = '<b>File not found</b>';
        }
      }

      function argument(key, drive_opts) {
        var value = document.getElementById('qemu_' + key).value;
        if(value == '') {
          return [];
        } else {
          if(drive_opts === null)
            return [];
          if(drive_opts === SPECIAL_FILE || drive_opts === RAW_TEXT)
            return ['-' + key, value];
          if(isRawImage(value))
            return ['-drive', drive_opts + ',format=raw,file=' + value];
          else
            return ['-drive', drive_opts + ',file=' + value];
        }
      }

      function prepareFiles(keys, callback) {
        var counter = 1;
        function createFile(name, contents) {
          name = "//" + name;
          var ind = name.lastIndexOf('/');
          FS.createPath(
            '/',
            name.substr(0, ind),
            true,
            true);
          FS.createPreloadedFile(
            name.substr(0, ind),
            name.substr(ind + 1),
            contents,
            true, true,
            function() {
              counter -= 1;
              if(counter <= 0)
                setTimeout(callback, 0);
            },
            function() {},
            false, false,
            function() {});
        }
        for(var k_ in keys) {
          if(keys[k_] === RAW_TEXT || keys[k_] === null)
            continue;
          (function(k) {
            var value = document.getElementById('qemu_' + k).value;
            var output = document.getElementById('qemu_' + k + '_comment');
            var download = fileForDownload(value);
            var allocSize = allocationSize(value);
            if(download !== null) {
              var xhr = new XMLHttpRequest();
              counter += 1;
              xhr.onprogress = function(event) {
                if(event.lengthComputable) {
                  output.innerHTML = "Downloading: " + ((100 * event.loaded / event.total) | 0) + '%';
                }
              };
              xhr.onerror = function(event) {
                output.innerHTML = "<b>Download failed</b>";
              };
              xhr.onload = function(event) {
                var arrayBuffer = xhr.response;
                if(arrayBuffer && xhr.status == 200) {
                  output.innerHTML = "Download compelted";
                  createFile(value, new Uint8Array(arrayBuffer));
                } else {
                  output.innerHTML = "Error " + xhr.status;
                }
              };
              xhr.open("GET", download, true);
              xhr.responseType = "arraybuffer";
              xhr.send(null);
            }
            if(allocSize !== null) {
              counter += 1;
              createFile(value, new Uint8Array(allocSize * 1024 * 1024));
            }
          }) (k_);
        }
        counter -= 1;
        if(counter <= 0)
          callback();
      }

      function applyCompilerSettings() {
        var threshold = document.getElementById("tbCompileThreshold").value | 0;
        var count = document.getElementById("printNextCompiledTBs").value | 0;
        Module._update_compiler_settings(threshold, print);
      }

      function resetCompilerCache() {
        for(k of Object.keys(CompiledTB)) {
          Module._fast_invalidate_tb(k|0);
        }
      }

      function runQemu() {
        var args = presets[archElement.value].args.concat(['-m', qemu_m_element.value]);
        for(k in qemu_args) {
          args = args.concat(argument(k, qemu_args[k]))
        }
        applyCompilerSettings();
        args = args.concat(qemuMiscOptionsElement.value.split(" ").filter(function(str) { return str != ""; }))
        prepareFiles(
          qemu_args,
          function() {
            mainControlsElement.style.display = 'block';
            configurationElement.style.display = 'none';
            Module.callMain(args);
          });
      }

      setDownloading(false);
      function initpage()
      {
        downloadQemu();
      }

    </script>
    <!--
    {{{ SCRIPT }}}
    -->
  </body>
</html>
